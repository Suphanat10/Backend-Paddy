name: Deploy Backend-Paddy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: 8000
        run: |
          set -e

          TARGET_DIR="/var/www/html/smart-paddy/backend"

          echo "ðŸš€ Syncing files to $TARGET_DIR..."
          mkdir -p "$TARGET_DIR"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            ./ "$TARGET_DIR/"

          cd "$TARGET_DIR"

          echo "ðŸ” Creating .env file..."
          cat > .env <<EOF
DATABASE_URL=$DATABASE_URL
JWT_SECRET=$JWT_SECRET
PORT=$PORT
EOF

          echo "ðŸ›‘ Removing old containers..."
          docker compose down -v

          echo "ðŸ›¢ï¸ Rebuilding Containers..."
          docker compose up -d --build --force-recreate

          echo "ðŸ§¹ Cleaning unused images..."
          docker image prune -f

          echo "âœ… Backend Deployment Successful!"

