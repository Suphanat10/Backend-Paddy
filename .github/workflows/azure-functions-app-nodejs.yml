name: Deploy Backend-Paddy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted # ‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Runner ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏á

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend
        run: |
          # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ö‡∏ô Server (‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Nginx ‡∏´‡∏≤‡πÄ‡∏à‡∏≠)
          TARGET_DIR="/var/www/html/smart-paddy/backend"
          
          echo "üöÄ Moving files to $TARGET_DIR..."
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
          mkdir -p $TARGET_DIR

          # ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Repo ‡∏ô‡∏µ‡πâ (‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô root ‡πÅ‡∏•‡πâ‡∏ß) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
          # --delete ‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô Server ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô GitHub ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
          rsync -avz --delete --exclude '.git' --exclude 'node_modules' ./ $TARGET_DIR/

          # ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á Docker
          cd $TARGET_DIR
          
          echo "üõ¢Ô∏è Rebuilding Containers..."
          
          # ‡∏™‡∏±‡πà‡∏á Docker Compose
          docker compose down
          docker compose up -d --build
          
          # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏¢‡∏∞
          docker image prune -f
          
          echo "‚úÖ Backend Deployed Successfully!"
