name: Deploy Backend-Paddy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: 8000
        run: |
          set -e

          TARGET_DIR="/var/www/html/smart-paddy/backend"

          echo "ğŸš€ Syncing files to $TARGET_DIR..."
          mkdir -p "$TARGET_DIR"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            ./ "$TARGET_DIR/"

          cd "$TARGET_DIR"

          echo "ğŸ” Creating .env file..."
          printf "DATABASE_URL=%s\nJWT_SECRET=%s\nPORT=%s\n" \
            "$DATABASE_URL" "$JWT_SECRET" "$PORT" > .env

          echo "ğŸ›‘ Removing old containers..."
          docker compose down -v || true

          echo "ğŸ›¢ï¸ Rebuilding Containers..."
          docker compose up -d --build --force-recreate

          echo "ğŸ§¹ Cleaning unused images..."
          docker image prune -f

          echo "âœ… Backend Deployment Successful!"

