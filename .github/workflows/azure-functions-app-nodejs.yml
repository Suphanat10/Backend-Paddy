name: Deploy Backend Only

on:
  push:
    branches: [ "main" ]
    # (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå backend
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'

jobs:
  deploy-backend:
    runs-on: self-hosted  # ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Server ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync Backend Files
        run: |
          # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå backend
          TARGET_DIR="/var/www/html/smart-paddy/backend"
          
          echo "üöÄ Syncing backend files..."
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
          mkdir -p $TARGET_DIR

          # ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå 'backend' ‡πÉ‡∏ô GitHub ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
          # --delete ‡∏Ñ‡∏∑‡∏≠‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Server ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô GitHub ‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞)
          rsync -avz --delete ./backend/ $TARGET_DIR/

      - name: Start Services
        run: |
          TARGET_DIR="/var/www/html/smart-paddy/backend"
          cd $TARGET_DIR
          
          echo "üõ¢Ô∏è Rebuilding Backend Containers..."
          
          # ‡∏™‡∏±‡πà‡∏á Docker Compose ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          docker compose down
          docker compose up -d --build
          
          # ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏¢‡∏∞
          docker image prune -f
          
          echo "‚úÖ Backend Deployment Successful!"
