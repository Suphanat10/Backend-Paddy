name: Deploy Backend-Paddy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    environment: ENV   # ğŸ”¥ GitHub Environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: 8000
        run: |
          set -e

          TARGET_DIR="/var/www/html/smart-paddy/backend"

          echo "ğŸš€ Syncing files..."
          mkdir -p "$TARGET_DIR"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            ./ "$TARGET_DIR/"

          cd "$TARGET_DIR"

          echo "ğŸ” Creating .env"
          printf "DATABASE_URL=%s\nJWT_SECRET=%s\nPORT=%s\n" \
            "$DATABASE_URL" "$JWT_SECRET" "$PORT" > .env

          echo "ğŸ›‘ Stop old containers"
          docker compose down || true

          echo "ğŸ›¢ï¸ Build & start containers"
          export COMPOSE_PROJECT_NAME=backend-paddy
          docker compose up -d --build --force-recreate

          echo "ğŸ§¬ Run Prisma migrate (IMPORTANT)"
          docker compose exec -T node-server npx prisma migrate deploy

          echo "ğŸ§¹ Cleanup images"
          docker image prune -f

          echo "âœ… Backend Deployment Successful!"


